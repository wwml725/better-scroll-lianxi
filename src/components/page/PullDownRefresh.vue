<template>
  <div class="container">
    <Header :back="true"></Header>

    <div class="pulldown">
      <div ref="bsWrapper" class="pulldown-bswrapper">
        <div class="pulldown-scroller">
          <div class="pulldown-wrapper">
            <div v-show="beforePullDown">
              <span>Pull Down and refresh</span>
            </div>
            <div v-show="!beforePullDown">
              <div v-show="isPullingDown">
                <span>Loading...</span>
              </div>
              <div v-show="!isPullingDown"><span>Refresh success</span></div>
            </div>
          </div>
          <ul class="pulldown-list">
            <li v-for="i of dataList" :key="i" class="pulldown-list-item">
              {{ `I am item ${i} ` }}
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>


</template>

<script>
  import Header from "@/components/base/Header.vue"
  import BScroll from '@better-scroll/core'
  import PullDown from '@better-scroll/pull-down'

  BScroll.use(PullDown);

  function getOneRandomList() {
    const arr = Array.apply(null, {length: 30}).map((...args) => args[1]);
    return arr.sort(() => Math.random() - 0.5)
  }

  const TIME_BOUNCE = 800;//回弹的总时间
  const TIME_STOP = 600;
  const THRESHOLD = 70;  //从顶部下拉的距离
  const STOP = 56;  //停止  回弹停留的距离

  export default {
    data() {
      return {
        beforePullDown: true,
        isPullingDown: false,
        dataList: getOneRandomList()
      }
    },
    created() {
      this.bscroll = null
    },
    mounted() {
      this.initBscroll()
    },
    methods: {
      initBscroll() {
        this.bscroll = new BScroll(this.$refs.bsWrapper, {
          scrollY: true,
          bounceTime: TIME_BOUNCE,
          pullDownRefresh: {
            threshold: THRESHOLD,
            stop: STOP
          }
        });

        this.bscroll.on('pullingDown', this.pullingDownHandler)
        // this.bscroll.on('scroll', this.scrollHandler)
      },

      scrollHandler(pos) {
        console.log(pos.y)
      },

      async pullingDownHandler() {
        console.log("松开的时候执行此代码");
        this.beforePullDown = false
        this.isPullingDown = true

        await this.requestData()

        this.isPullingDown = false
        this.finishPullDown()
      },

      async finishPullDown() {
        const stopTime = TIME_STOP
        await new Promise(resolve => {
          setTimeout(() => {
            this.bscroll.finishPullDown()
            resolve()
          }, stopTime)
        })

        setTimeout(() => {
          this.beforePullDown = true
          this.bscroll.refresh()
        }, TIME_BOUNCE)
      },

      async requestData() {
        try {
          const newData = await this.ajaxGet(/* url */)
          this.dataList = newData
        } catch (err) {
          // handle err
          console.log(err)
        }
      },

      ajaxGet(/* url */) {
        return new Promise(resolve => {
          setTimeout(() => {
              const dataList = getOneRandomList()
              resolve(dataList)
            }, 1000
          )
        })
      }
    },
    components: {
      Header
    }
  }
</script>

<style scoped lang="scss">
  @import "../../common/style/mixin";

  .container {
    height: 100%;
    @include allcover;
    @include wh(100%, 100%);
  }

  .pulldown {
    position: absolute;
    top: 2rem;
    bottom: 0;
    right: 0;
    left: 0;


  }

  .pulldown-bswrapper {
    position: relative;
    height: 100%;
    padding: 0 10px;
    border: 1px solid #ccc;
    /*overflow: hidden;*/
  }

  .pulldown-list {
    padding: 0
  }

  .pulldown-list-item {
    padding: 10px 0;
    list-style: none;
    border-bottom: 1px solid #ccc
  }

  .pulldown-wrapper {
    position: absolute;
    width: 100%;
    padding: 20px;
    box-sizing: border-box;
    transform: translateY(-100%) translateZ(0);
    text-align: center;
    color: #999
  }


</style>

